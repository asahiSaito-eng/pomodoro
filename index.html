<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ポモドーロタイマー</title>

<!-- PWA manifest -->
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#ff055b">

<!-- Apple Touch Icon -->
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon-180.png">

<style>
html, body {
  margin:0; padding:0;
  font-family: sans-serif;
  height: 100%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: linear-gradient(to top, #ff055b, #f59c01);
}

#timer-container {
  position: relative;
  width: 280px;
  height: 280px;
  margin-bottom: 20px;
}

canvas {
  position: absolute;
  top:0; left:0;
}

#time {
  position: absolute;
  top: 40%;
  width: 100%;
  text-align: center;
  font-size: 56px;
  font-weight: bold;
  color: white;
}

#status {
  position: absolute;
  top: 70%;
  width: 100%;
  text-align: center;
  font-size: 20px;
  color: white;
}

#controls {
  display: flex;
  justify-content: center;
  gap: 30px;
  margin-bottom: 20px;
}

.btn-img {
  width: 60px;
  height: 60px;
  cursor: pointer;
  user-select: none;
  object-fit: contain;
}

#pomodoro-count {
  font-size: 16px;
  color: white;
  margin-top: 20px;
}
</style>
</head>
<body>

<div id="timer-container">
  <canvas id="timer-canvas" width="280" height="280"></canvas>
  <div id="time">25:00</div>
  <div id="status">作業開始</div>
</div>

<div id="controls">
  <img id="start-pause-btn" src="/img/play.png" class="btn-img">
  <img id="stop-btn" src="/img/stop.png" class="btn-img" style="display:none;">
</div>

<div id="pomodoro-count">現在 0 ポモドーロ</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const timerDisplay = document.getElementById("time");
  const statusText = document.getElementById("status");
  const pomodoroCount = document.getElementById("pomodoro-count");
  const startPauseBtn = document.getElementById("start-pause-btn");
  const stopBtn = document.getElementById("stop-btn");
  const canvas = document.getElementById("timer-canvas");
  const ctx = canvas.getContext("2d");

  const radius = canvas.width / 2 - 10;
  const centerX = canvas.width / 2;
  const centerY = canvas.height / 2;

  let phase = "work"; // work, shortBreak, longBreak
  let count = 0;
  let timer = 25 * 60;
  let isRunning = false;
  const workTime = 25 * 60;
  const shortBreak = 5 * 60;
  const longBreak = 20 * 60;

  let lastFrameTime = null;

  const audio = new Audio("/alarm.mp3");
  audio.preload = "auto";

  function saveState() {
    localStorage.setItem("pomodoro_state", JSON.stringify({
      phase, count, timer, isRunning, lastStart: Date.now()
    }));
  }

  if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .then(() => console.log('Service Worker registered'));
  }

  function loadState() {
    const data = localStorage.getItem("pomodoro_state");
    if (!data) return;
    const state = JSON.parse(data);
    phase = state.phase;
    count = state.count;
    isRunning = state.isRunning;
    let elapsed = Math.floor((Date.now() - state.lastStart)/1000);
    timer = state.timer - elapsed;
    if (timer < 0) timer = 0;
    updateUI();
    drawCircle();
    updateButtons();
  }

  function setPhase(newPhase) {
    phase = newPhase;
    if (phase === "work") {
      timer = workTime;
      statusText.textContent = "作業中";
      document.body.style.background = "linear-gradient(to top, #ff055b, #f59c01)";
    } else if (phase === "shortBreak") {
      timer = shortBreak;
      statusText.textContent = "小休憩";
      document.body.style.background = "linear-gradient(to top, #4facfe, #00f2fe)";
    } else {
      timer = longBreak;
      statusText.textContent = "大休憩";
      document.body.style.background = "linear-gradient(to top, #43e97b, #38f9d7)";
    }
    updateUI();
    drawCircle();
    saveState();
    updateButtons();
  }

  function updateUI() {
    const minutes = String(Math.floor(timer/60)).padStart(2,"0");
    const seconds = String(Math.floor(timer%60)).padStart(2,"0");
    timerDisplay.textContent = `${minutes}:${seconds}`;
    pomodoroCount.textContent = `現在 ${count} ポモドーロ`;
  }

  function drawCircle() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // 背景薄灰色円
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, 2*Math.PI);
    ctx.strokeStyle = "rgba(200,200,200,0.3)";
    ctx.lineWidth = 6;
    ctx.stroke();

    // 進行円（白）
    const total = (phase==="work")? workTime : (phase==="shortBreak"? shortBreak: longBreak);
    const progress = 2*Math.PI * (timer/total);
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, -Math.PI/2, -Math.PI/2 + progress, false); // 逆回り
    ctx.strokeStyle = "#fff";
    ctx.lineWidth = 6;
    ctx.stroke();
  }

  function startTimer() {
    if (isRunning) return;
    isRunning = true;
    updateButtons();
    if (phase === "work" && timer === workTime && count === 0) {
      statusText.textContent = "作業中";
    } else if (phase === "work") {
      statusText.textContent = "作業中";
    } else if (phase === "shortBreak") {
      statusText.textContent = "小休憩";
    } else if (phase === "longBreak") {
      statusText.textContent = "大休憩";
    }
    lastFrameTime = performance.now();
    requestAnimationFrame(loop);
  }

  function pauseTimer() {
    isRunning = false;
    statusText.textContent = "一時停止中";
    updateButtons();
    saveState();
  }

  function stopTimer() {
    isRunning = false;
    setPhase("work");
    statusText.textContent = "作業開始";
    updateButtons();
    saveState();
  }

  function loop(timestamp) {
    if (!isRunning) return;
    const delta = (timestamp - lastFrameTime) / 1000;
    lastFrameTime = timestamp;
    timer -= delta;
    if (timer <= 0) {
      timer = 0;
      updateUI();
      drawCircle();
      playAlarm();
      nextPhase();
      return;
    }
    updateUI();
    drawCircle();
    requestAnimationFrame(loop);
  }

  function nextPhase() {
    if (phase==="work") {
      count++;
      if (count % 4 === 0) setPhase("longBreak");
      else setPhase("shortBreak");
    } else {
      setPhase("work");
    }
    saveState();
    startTimer();
  }

  function playAlarm() {
    audio.currentTime = 0;
    audio.play().catch(e=>console.log(e));
    if ("Notification" in window && Notification.permission === "granted") {
      new Notification("ポモドーロタイマー", {
        body: (phase==="work")? "休憩しましょう":"作業を再開しましょう",
        icon: "/img/apple-touch-icon-180.png"
      });
    }
  }

  function updateButtons() {
    if (phase === "work" && !isRunning && timer===workTime) {
      startPauseBtn.src="/img/play.png";
      stopBtn.style.display="none";
    } else if (isRunning) {
      startPauseBtn.src="/img/pause.png";
      stopBtn.style.display="inline-block";
    } else if (!isRunning && phase !== "work") {
      startPauseBtn.src="/img/play.png";
      stopBtn.style.display="inline-block";
    } else if (!isRunning && phase==="work") {
      startPauseBtn.src="/img/play.png";
      stopBtn.style.display="inline-block";
    }
  }

  startPauseBtn.addEventListener("click",()=>{
    if (!isRunning) startTimer();
    else pauseTimer();
    updateButtons();
  });

  stopBtn.addEventListener("click",()=>stopTimer());

  if ("Notification" in window && Notification.permission!=="granted") {
    Notification.requestPermission();
  }

  loadState();
  drawCircle();
  updateUI();
  updateButtons();
});
</script>
</body>
</html>
